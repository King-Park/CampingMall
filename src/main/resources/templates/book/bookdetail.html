<script th:src="@{/js/bookdetail.js}">
//예약코드(insert디폴트)
//작성일(insert디폴트)
//사이트코드(request)대신 사이트이름
//주문번호(request) 결제단에 넣기
//체크인(request)
//체크아웃(request)
//예약상태(server) 결제단에 넣기
//유저코드(session) 결제단에 넣기
//인원수(form) 결제단에넣기
//차량번호(form) 결제단에넣기
//사이트가격(request)
//결제총가격(form) 결제단에넣기
</script>
<!-- iamport.payment.js -->
<script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
<script>
const IMP = window.IMP; // 생략 가능
IMP.init("imp57467885"); // 예: imp00000000a

//우선 해야할것
//다수의 이용자가 동시에 같은자리 같은시간에 예약하게 될경우를 방지하기위해
//결제 직전에 그 사이트 그자리가 예약이 되는지 확인하는 작업이 필요
//결제완료시 update

function paymentDo() {
$.ajax({
    type: "get",
    url: "/pay/import", // 최종 결제전에 마지막으로 해당 좌석이 예매가능한 상태인지 확인 요청
    data: {
    	'stringDate1':'20230128',
    	'stringDate2':'20230201',
    	'sitecode':1
    },
    success: function(data) {
        if (data) {
            var IMP = window.IMP; 
            IMP.init('imp93258645');// 아임포트 라이브러리를 통해서 가맹점정보를 불러옴
            IMP.request_pay({
                pg: 'html5_inicis', // 웹 표준 결제
                pay_method: $(":input:radio[name=paycard]:checked").val(), //결제수단
                merchant_uid: mid, // 결제 고유번호
                name: '테스트 주문', // 결제 상품 이름
                amount: money, // 결제금액 ( RestAPI를 호출한 상태이기 때문에 금액 변조시 결제창이 뜨지 않고 오류 )
                buyer_tel: '${sessionScope.loginInfo.userPhone}' // 유저 전화번호 ( 필수 )
            }, function(rsp) { // 콜백 함수
                if (rsp.success) {
                	// 결제 정보를 form에 담음
                    $('#checkSeat').val('${pInfo.checkSeat}');
                    $('#merchant_uid').val(rsp.merchant_uid);
                    $('#paid_amount').val(rsp.paid_amount);
                    $('#pay_method').val(rsp.pay_method);
                    var queryString = $("#form").serialize();
                    $.ajax({
                        type: "post",
                        url: "/civ/payment/paid", //최종 결제정보를 서버로 전달
                        data: queryString,
                        success: function(data) {
                            if (data == "failed") {
                                alert('결제 실패');
                            } else {
                                // 성공시 웹소켓을 사용해서 해당 스케줄을 보고있는 사람들에게도 좌석 정보를 업데이트
                                var webSocket = new WebSocket("ws://192.168.219.101/civ/websocket/${pInfo.scheduleCode}");
                                webSocket.onopen = () => webSocket.send(data);
                                webSocket.onclose = function(message) {
                                    disconnect();
                                };
                                function disconnect() {
                                    webSocket.close();
                                }
                                // 결제 확인창으로 이동
                                location.href = "/civ/payment/payok";
                            }
                        }
                    })
                } else {
                    alert('결제 실패하셨습니다.');
                }
            });
        } else {
            alert('결제 오류');
        }
    }
});
}


//	function paymentDo() {
//	    IMP.request_pay({
//	      pg: "html5_inicis",
//	      pay_method: "card", //다른 타입들 입력받아 넣는 테스트 필요
//	      merchant_uid:"122141",  // 주문번호
//	      name: "노르웨이 회전 의자", //뷰단에서 입력받아와야함
//	      amount: 100,                         // 숫자 타입 뷰단에서 입력받아와야함
//	      buyer_name: "홍길동", // 뷰단에서 입력받아와야함
//	      buyer_tel: "010-4242-4242", // 뷰단에서 입력받아와야함
//	    }, function (rsp) { // callback
//	      if (rsp.success) {
    	  
//	    	  let param = {'imp_uid':rsp.imp_uid, 'merchant_uid':rsp.merchant_uid};
//	        // 결제 성공 시 로직
//	    	  jQuery.ajax({
//	    	        url: "/pay/paymentOK", 
//	    	        type: "POST",
//	    	        contentType:"application/json;charset=utf-8",
//	    	        dataType:"json",
//	    	        data: JSON.stringify(param)
//	    	      }).done(function (data) {
//	    	    	  alert("결제성공")
//	    	    	  //결제검증절차
    	    	  
//	    	      })
    	   
//	      } else {
//	        // 결제 실패 시 로직
//	    	  alert("결제실패"+rsp);
//	      }
//	    });
//	  }

</script>
<link rel="stylesheet" th:href="@{/css/bookdetail.css}">
<div class="back_re">
   <div class="container">
      <div class="row">
         <div class="col-md-12">
            <div class="title">
               <h2>예약내역</h2>
            </div>
         </div>
      </div>
   </div>
</div>
<div class="bg">
	<div class="container reservation-main">
		<section class="page-container">
			<section class="zone-content">
				<section class="zone-container">
					<div class="zone-image">
						<img alt="구역이미지" th:src="@{/images/banner1.jpg}" >
					</div>
					<div class="zone-info">
						<div class="zone-name" th:text="${book.site_name}"></div>
						<div class="zone-total">기준인원2명</div>
						<div class="zone-car">기준차량1대</div>
					</div>
				</section>
			</section>
			<section class="period-content" >
				<section class="period-container">
					<div class="checkinout-box">
						<div class="checkinout">
							<span>체크인</span>
							<span th:text="${book.book_checkin}"></span>
						</div>
						<div class="checkinout">
							<span>체크아웃</span>
							<span th:text="${book.book_checkout}"></span>
						</div>
					</div>
				</section>
			</section>
			<section class="customer-content">
				<section class="customer-container">
					<div class="customer-total section-title">전체인원정보</div>
					<div>
						<span>성인</span>
						<span class="customer-count">
							<button type="button" onclick='count("plus",1)' class="btn btn-outline-primary">+</button>
							<span id="result1">2</span>
							<button type="button" onclick='count("minus",1)' class="btn btn-outline-danger">-</button>
						</span>
					</div>
					<div>
						<span>미성년자</span>
						<span class="customer-count">
							<button type="button" onclick='count("plus",2)' class="btn btn-outline-primary">+</button>
							<span id="result2">0</span>
							<button type="button" onclick='count("minus",2)' class="btn btn-outline-danger">-</button>
						</span>
					</div>
					<section class="customer-count-result customer-container">
						<div>
							<span>기준인원</span>
							<span id="basic-count">2</span>명
						</div>
						<div>
							<span>추가 가능인원</span>
							<span>2명</span>
						</div>
						<div>
							<span>총인원제한</span>
							<span id="limit-count">4</span>명
						</div>
						<div id="over-count">
							<span>인원초과요금</span>
							<span id="over-count-num">0</span>명
						</div>
					</section>
				</section>	
			</section>
			<section>
				<section>
					<div>*잠시 방문하는 게스트도 인원 정보에 포함해야 합니다.</div>
					<div>*사회적 거리두기 조치에 따라 예약내용에 없는 게스트는 캠핑장 입장이 불허할 수 있으니 예약시 주의바랍니다.</div>
				</section>
			</section>
			<section class="car-info-content">
				<section class="car-info-container">
					<div class="section-title">전체 차량 정보</div>
					<div class="alert alert-info" style="margin-top: 22px;" role="alert">
						<div class="car-title">차량</div>
						<form>
							<div class="form-container">
								<div class="car-num">차량번호</div><input type="email" class="form-control" id="exampleFormControlInput1" placeholder="차량번호를 입력해주세요">
							</div>
						</form>
					</div>
				</section>
			</section>
			<section class="addition-content bord-line">
				<section class="addition-container customer-container">
					<div>추가구매</div>				
					<div>
						<span class="addition-item verticality">
							<span>불멍(모닥불)</span>
							<span>20000원</span>
						</span>
						<span>
							<button type="button" onclick='addition_count("plus",4)' class="btn btn-outline-primary">+</button>
							<span id="result4">0</span>
							<button type="button" onclick='addition_count("minus",4)' class="btn btn-outline-danger">-</button>
						</span>
					</div>
					<div>
						<span class="addition-item verticality">
							<span>빠른입실</span>
							<span>20000원</span>
						</span>
						<span>
							<button type="button" onclick='addition_count("plus", 5)' class="btn btn-outline-primary">+</button>
							<span id="result5">0</span>
							<button type="button" onclick='addition_count("minus",5)' class="btn btn-outline-danger">-</button>
						</span>
					</div>
					<div>
						<span class="addition-item verticality">
							<span>바베큐 그릴</span>
							<span>20000원</span>
						</span>
						<span>
							<button type="button" onclick='addition_count("plus",6)' class="btn btn-outline-primary">+</button>
							<span id="result6">0</span>
							<button type="button" onclick='addition_count("minus",6)' class="btn btn-outline-danger">-</button>
						</span>
					</div>				
				</section>
			</section>
			<section class="reservation-cost-content bord-line">
				<section class="reservation-cost-container">
					<div>할인 적용</div>
					<div style="display:flex;">
 						<div style="flex:1;">쿠폰</div><div style="flex:1; text-align: right;">적용 가능한 쿠폰이 없음</div>				
					</div>				
				</section>
			</section>
			<section class="reservation-cost-content">
				<section class="reservation-cost-container customer-container reservation-cost-container-total">
					<div>결제 금액</div>				
					<div>
						<span>숙박 예약 요금</span>
						<span>
							<span id="result7" th:text="${book.book_price}"></span>원
						</span>
					</div>
					<div>
						<span>초과 인원 요금</span>
						<span>
							<span id="result3">0</span>원
						</span>
					</div>
					<div>
						<span>불멍(모닥불)</span>
						<span>
							<span>20000</span>원
						</span>
					</div>
					<div>
						<span>빠른입실</span>
						<span>
							<span>20000</span>원
						</span>
					</div>
					<div>
						<span>바베큐 그릴</span>
						<span>
							<span>20000</span>원
						</span>
					</div>
					<div class="total-result-container">
						<span>총 결제 금액</span>
						<span>
							<span id="total_result">0</span>원
						</span>
					</div>				
				</section>
			</section>
			<section>
				<section>
				<button type="button" class="btn btn-success pay-go">결제하기</button>
				</section>
			</section>
		</section>
	</div>
</div>




